<!doctype html>
<html lang="{{ .Site.Language.Lang | default "en" }}">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <!-- Set theme immediately to prevent flash -->
    <script>
      (function() {
        try {
          const theme = localStorage.getItem('theme') || 'light';
          document.documentElement.setAttribute('data-theme', theme);
          document.documentElement.style.colorScheme = theme;
        } catch (e) {
          // Fallback to light theme if localStorage fails
          document.documentElement.setAttribute('data-theme', 'light');
          document.documentElement.style.colorScheme = 'light';
        }
      })();
    </script>
    {{ block "desc" . }}
      {{ if .Description }}
        <meta name="description" content="{{ .Description }}" />
      {{ else if .Site.Params.description }}
        <meta name="description" content="{{ .Site.Params.description }}" />
      {{ end }}
    {{ end }}
    <title>{{ block "title" . }}{{ .Title }} | {{ .Site.Title }}{{ end }}</title>
    <link rel="icon" type="image/svg+xml" href="{{ "img/favicon.svg" | relURL }}" />
    <link rel="icon" type="image/png" sizes="32x32" href="{{ "img/favicon-32x32.png" | relURL }}" />
    <link rel="icon" type="image/png" sizes="16x16" href="{{ "img/favicon-16x16.png" | relURL }}" />
    <link rel="apple-touch-icon" sizes="180x180" href="{{ "img/apple-touch-icon.png" | relURL }}" />
    
    <!-- NOTE: Optional: add custom fonts -->
    {{ partialCached "custom_font.html" . }}
    <!-- NOTE: Optional: add custom css -->
    {{ partialCached "custom_css.html" . }}

    {{/* Base CSS - always needed - bundled with Hugo pipes */}}
    {{ $baseFiles := slice "css/tokens.css" "css/theme.css" "css/layout.css" "css/typography.css" "css/navigation.css" "css/footer.css" "css/back-to-top.css" "css/cursor.css" }}
    {{ $baseCSS := slice }}
    {{ range $baseFiles }}
      {{ $css := resources.Get . }}
      {{ if $css }}
        {{ $baseCSS = $baseCSS | append $css }}
      {{ end }}
    {{ end }}
    {{ $baseBundled := $baseCSS | resources.Concat "css/base-bundle.css" | minify | fingerprint }}
    <link rel="stylesheet" href="{{ $baseBundled.Permalink }}" integrity="{{ $baseBundled.Data.Integrity }}" crossorigin="anonymous">
    
    {{/* Template-specific CSS */}}
    {{ if .IsHome }}
      {{/* Home page */}}
      {{ $homeFiles := slice "css/home.css" }}
      {{ if .Content }}
        {{ $homeFiles = $homeFiles | append "css/syntax.css" "css/shortcodes.css" "css/responsive-images.css" "css/anchors.css" }}
      {{ end }}
      {{ $homeCSS := slice }}
      {{ range $homeFiles }}
        {{ $css := resources.Get . }}
        {{ if $css }}
          {{ $homeCSS = $homeCSS | append $css }}
        {{ end }}
      {{ end }}
      {{ $homeBundled := $homeCSS | resources.Concat "css/home-bundle.css" | minify | fingerprint }}
      <link rel="stylesheet" href="{{ $homeBundled.Permalink }}" integrity="{{ $homeBundled.Data.Integrity }}" crossorigin="anonymous">
    {{ else if .IsPage }}
      {{/* Check if this is a post page */}}
      {{ $isPost := false }}
      {{ if .Params.tags }}
        {{ $isPost = true }}
      {{ else if .Date }}
        {{ $blogSection := .Site.Params.blog_section_path | default "/posts" }}
        {{ if or (hasPrefix .RelPermalink $blogSection) (hasPrefix .RelPermalink "/reviews/") }}
          {{ $isPost = true }}
        {{ end }}
      {{ end }}
      
      {{ if $isPost }}
        {{/* Post page */}}
        {{ $postFiles := slice "css/blog.css" "css/anchors.css" "css/shortcodes.css" "css/responsive-images.css" "css/collection.css" "css/syntax.css" }}
        {{ $postCSS := slice }}
        {{ range $postFiles }}
          {{ $css := resources.Get . }}
          {{ if $css }}
            {{ $postCSS = $postCSS | append $css }}
          {{ end }}
        {{ end }}
        {{ $postBundled := $postCSS | resources.Concat "css/post-bundle.css" | minify | fingerprint }}
        <link rel="stylesheet" href="{{ $postBundled.Permalink }}" integrity="{{ $postBundled.Data.Integrity }}" crossorigin="anonymous">
      {{ else }}
        {{/* Prose/other pages */}}
        {{ $proseFiles := slice "css/prose.css" "css/anchors.css" "css/shortcodes.css" "css/responsive-images.css" "css/collection.css" "css/syntax.css" }}
        {{ $proseCSS := slice }}
        {{ range $proseFiles }}
          {{ $css := resources.Get . }}
          {{ if $css }}
            {{ $proseCSS = $proseCSS | append $css }}
          {{ end }}
        {{ end }}
        {{ $proseBundled := $proseCSS | resources.Concat "css/prose-bundle.css" | minify | fingerprint }}
        <link rel="stylesheet" href="{{ $proseBundled.Permalink }}" integrity="{{ $proseBundled.Data.Integrity }}" crossorigin="anonymous">
      {{ end }}
    {{ else if .IsSection }}
      {{ $blogPath := .Site.Params.blog_section_path | default "/posts/" }}
      {{ if or (eq .RelPermalink $blogPath) (hasPrefix .RelPermalink "/posts") }}
        {{/* Blog listing page */}}
        {{ $blogListFiles := slice "css/blog.css" "css/collection.css" }}
        {{ $blogListCSS := slice }}
        {{ range $blogListFiles }}
          {{ $css := resources.Get . }}
          {{ if $css }}
            {{ $blogListCSS = $blogListCSS | append $css }}
          {{ end }}
        {{ end }}
        {{ $blogListBundled := $blogListCSS | resources.Concat "css/blog-list-bundle.css" | minify | fingerprint }}
        <link rel="stylesheet" href="{{ $blogListBundled.Permalink }}" integrity="{{ $blogListBundled.Data.Integrity }}" crossorigin="anonymous">
      {{ else }}
        {{/* Other section pages */}}
        {{ $sectionFiles := slice "css/prose.css" "css/anchors.css" "css/shortcodes.css" "css/responsive-images.css" "css/collection.css" "css/syntax.css" }}
        {{ $sectionCSS := slice }}
        {{ range $sectionFiles }}
          {{ $css := resources.Get . }}
          {{ if $css }}
            {{ $sectionCSS = $sectionCSS | append $css }}
          {{ end }}
        {{ end }}
        {{ $sectionBundled := $sectionCSS | resources.Concat "css/section-bundle.css" | minify | fingerprint }}
        <link rel="stylesheet" href="{{ $sectionBundled.Permalink }}" integrity="{{ $sectionBundled.Data.Integrity }}" crossorigin="anonymous">
      {{ end }}
    {{ else if .Data.Plural }}
      {{/* Taxonomy pages */}}
      {{ $taxonomyFiles := slice "css/taxonomy.css" }}
      {{ if .Data.Term }}
        {{ $taxonomyFiles = $taxonomyFiles | append "css/blog.css" "css/collection.css" "css/anchors.css" "css/shortcodes.css" "css/responsive-images.css" "css/syntax.css" }}
      {{ end }}
      {{ $taxonomyCSS := slice }}
      {{ range $taxonomyFiles }}
        {{ $css := resources.Get . }}
        {{ if $css }}
          {{ $taxonomyCSS = $taxonomyCSS | append $css }}
        {{ end }}
      {{ end }}
      {{ $taxonomyBundled := $taxonomyCSS | resources.Concat "css/taxonomy-bundle.css" | minify | fingerprint }}
      <link rel="stylesheet" href="{{ $taxonomyBundled.Permalink }}" integrity="{{ $taxonomyBundled.Data.Integrity }}" crossorigin="anonymous">
    {{ end }}
    
    {{/* Math rendering with KaTeX */}}
    {{ if .Param "math" }}
      {{ partialCached "math.html" . }}
    {{ end }}
    
    {{ block "head" . }}{{ end }}
  </head>
  <body class="{{ block "page" . }}{{ end }}{{ if eq .Site.Params.force_theme "dark" }} dark{{ end }}{{ if .IsSection }}{{ if hasPrefix .RelPermalink "/posts" }} section-posts{{ end }}{{ end }}" id="body-element">
    {{ if ne .Site.Params.force_theme "dark" }}{{ end }}

    <!-- Skip to main content link for keyboard navigation -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Back button (hidden on homepage) -->
    {{ if not .IsHome }}
      <nav class="back-nav">
        <a href="javascript:history.back()" class="back-link" aria-label="Go back">
          ‚Üê {{ .Site.Params.back_link_text | default "Back" }}
        </a>
      </nav>
    {{ end }}

    <!-- NOTE: Main content section -->
    <div id="main-content" tabindex="-1">
      {{ block "content" . }}{{ end }}
    </div>
    
    <!-- NOTE: Footer (hidden on homepage and 404 page) -->
    {{ if not .IsHome }}
      {{ if not (eq .Kind "404") }}
        {{ partial "footer.html" . }}
      {{ end }}
    {{ end }}
    
    <!-- Back to top link - fixed position, aligned with footer icons -->
    <button id="back-to-top" class="back-to-top-footer" aria-label="Back to top" title="Back to top">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M10 4L10 16M10 4L4 10M10 4L16 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <!-- NOTE: Scripts -->
    {{ block "script" . }}{{ end }}
    {{/* Main JS - always loaded */}}
    {{ $mainJS := resources.Get "js/main.js" | minify | fingerprint }}
    <script src="{{ $mainJS.Permalink }}" integrity="{{ $mainJS.Data.Integrity }}" crossorigin="anonymous" defer></script>

    {{/* Collection filter JS - only load on pages with collections */}}
    {{ if or .Params.collections (and .IsSection (or (in .RelPermalink "/posts") (in .RelPermalink "/picks"))) (.Data.Term) }}
      {{ $collectionJS := resources.Get "js/collection-filter.js" | minify | fingerprint }}
      <script src="{{ $collectionJS.Permalink }}" integrity="{{ $collectionJS.Data.Integrity }}" crossorigin="anonymous" defer></script>
    {{ end }}
    
    {{/* Mermaid for diagrams - auto-loaded when mermaid code blocks are present */}}
    {{ if .Store.Get "hasMermaid" }}
      {{ partial "mermaid.html" . }}
    {{ end }}
    
    {{/* KaTeX auto-render */}}
    {{ if .Params.math }}
      <script>
        // Wait for both DOM and deferred scripts to load
        function initKaTeX() {
          if (typeof renderMathInElement !== 'undefined') {
            renderMathInElement(document.body, {
              delimiters: [
                {left: "$$", right: "$$", display: true},
                {left: "$", right: "$", display: false},
                {left: "\\[", right: "\\]", display: true},
                {left: "\\(", right: "\\)", display: false}
              ],
              throwOnError: false
            });
          } else {
            // If not ready yet, wait for window load
            window.addEventListener('load', initKaTeX);
          }
        }
        
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initKaTeX);
        } else {
          // DOM already loaded, try immediately or wait for load
          initKaTeX();
        }
      </script>
    {{ end }}
  </body>
</html>

