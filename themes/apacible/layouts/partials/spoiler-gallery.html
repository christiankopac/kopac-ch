{{/*
  Spoiler Gallery Partial - Gallery with spoiler toggle
  Same as shortcode but as partial for use in templates
*/}}

{{ $file := .file }}
{{ $imagesParam := .images }}
{{ $columns := .columns | default "3" }}
{{ $label := .label | default "Show Images (Spoiler Alert)" }}
{{ $hideLabel := .hide_label | default "Hide Images" }}
{{ $thumbWidth := .thumb_width | default "300" }}
{{ $thumbHeight := .thumb_height | default "200" }}
{{ $fullWidth := .full_width | default "2400" }}
{{ $fullHeight := .full_height | default "1600" }}
{{ $thumbQuality := .thumb_quality | default "75" }}
{{ $fullQuality := .full_quality | default "95" }}
{{ $context := .context }}

{{ $images := slice }}
{{/* First check if images are passed directly (from frontmatter) */}}
{{ if $imagesParam }}
  {{ $images = $imagesParam }}
{{ else if $file }}
  {{/* Fallback to data file for backwards compatibility */}}
  {{ $dataPath := replace $file (path.Ext $file) "" }}
  {{ $dataPath = replace $dataPath "/" "." }}
  {{ $data := index $context.Site.Data $dataPath }}
  {{ if $data }}
    {{ if $data.images }}
      {{ $images = $data.images }}
    {{ else if $data }}
      {{/* If data is directly an array of images */}}
      {{ $images = $data }}
    {{ end }}
  {{ end }}
{{ end }}

<div class="spoiler-gallery-container" x-data="{ isOpen: false }">
  <button class="spoiler-toggle" 
          :class="{ active: isOpen }"
          @click="isOpen = !isOpen"
          :aria-expanded="isOpen"
          type="button">
    <span x-show="!isOpen">{{ $label }}</span>
    <span x-show="isOpen">{{ $hideLabel }}</span>
  </button>
  <div class="spoiler-content" 
       x-show="isOpen"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       aria-live="polite"
       style="display: none;">
    {{ if $images }}
    <div class="spoiler-screenshots">
      {{ range $images }}
        {{ $imgSrc := .src }}
        {{ $imgAlt := .alt | default "Screenshot" }}
        {{ $imgCaption := .caption | default "" }}
        
        {{/* Get image resource from assets directory (for optimization) */}}
        {{ $imgPath := strings.TrimPrefix "/" $imgSrc }}
        {{ $img := resources.Get $imgPath }}
        
        {{ if $img }}
          {{/* Optimize image - resize to max width while preserving aspect ratio */}}
          {{ $optimizedImg := $img.Resize (printf "%sx q%s" $fullWidth $fullQuality) }}
          {{ $optimizedWebP := $img.Resize (printf "%sx webp q%s" $fullWidth $fullQuality) }}
          {{ $optimizedAVIF := $img.Resize (printf "%sx avif q%s" $fullWidth $fullQuality) }}
          
          <figure class="screenshot-item">
            <picture>
              <source srcset="{{ $optimizedAVIF.RelPermalink }}" type="image/avif" width="{{ $optimizedAVIF.Width }}" height="{{ $optimizedAVIF.Height }}">
              <source srcset="{{ $optimizedWebP.RelPermalink }}" type="image/webp" width="{{ $optimizedWebP.Width }}" height="{{ $optimizedWebP.Height }}">
              <img src="{{ $optimizedImg.RelPermalink }}" 
                   alt="{{ $imgAlt }}" 
                   width="{{ $optimizedImg.Width }}"
                   height="{{ $optimizedImg.Height }}"
                   loading="lazy"
                   decoding="async">
            </picture>
            {{ if $imgCaption }}
            <figcaption>{{ $imgCaption }}</figcaption>
            {{ end }}
          </figure>
        {{ else }}
          {{/* Fallback to direct path if not found in assets (e.g., in static) */}}
          <figure class="screenshot-item">
            <img src="{{ $imgSrc | relURL }}" 
                 alt="{{ $imgAlt }}" 
                 loading="lazy"
                 decoding="async">
            {{ if $imgCaption }}
            <figcaption>{{ $imgCaption }}</figcaption>
            {{ end }}
          </figure>
        {{ end }}
      {{ end }}
    </div>
    {{ else }}
    <p><em>No screenshots available yet. Replace placeholder paths in data file.</em></p>
    {{ end }}
  </div>
</div>

