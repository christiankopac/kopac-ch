<script type="module">
  import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
  
  function getMermaidTheme() {
    const theme = document.documentElement.getAttribute('data-theme') || 'light';
    const isDark = theme === 'dark';
    
    // Get CSS variables from computed styles
    const styles = getComputedStyle(document.documentElement);
    const bgColor = styles.getPropertyValue('--color-bg').trim();
    const bgSecondary = styles.getPropertyValue('--color-bg-secondary').trim();
    const textColor = styles.getPropertyValue('--color-text').trim();
    const borderColor = styles.getPropertyValue('--color-border').trim();
    
    if (isDark) {
      return {
        theme: 'dark',
        themeVariables: {
          primaryColor: '#e8a89a',
          primaryTextColor: textColor,
          primaryBorderColor: '#f5c8ba',
          lineColor: '#c5b5ba',
          secondaryColor: '#a5c9b5',
          tertiaryColor: '#b5bdd9',
          background: bgColor,
          mainBkg: bgColor,
          secondBkg: bgColor,
          textColor: textColor,
          border1: borderColor,
          border2: borderColor,
          nodeBorder: borderColor,
          clusterBkg: bgSecondary,
          clusterBorder: borderColor,
          defaultLinkColor: textColor,
          titleColor: textColor,
          edgeLabelBackground: bgColor,
          nodeTextColor: textColor
        }
      };
    } else {
      return {
        theme: 'base',
        themeVariables: {
          primaryColor: '#d98a7a',
          primaryTextColor: textColor,
          primaryBorderColor: '#b87a6a',
          lineColor: '#4a524a',
          secondaryColor: '#7aa88a',
          tertiaryColor: '#8a9ab8',
          background: bgColor,
          mainBkg: bgColor,
          secondBkg: bgColor,
          textColor: textColor,
          border1: borderColor,
          border2: borderColor,
          nodeBorder: borderColor,
          clusterBkg: bgSecondary,
          clusterBorder: borderColor,
          defaultLinkColor: textColor,
          titleColor: textColor,
          edgeLabelBackground: bgColor,
          nodeTextColor: textColor
        }
      };
    }
  }
  
  function initMermaid() {
    const config = getMermaidTheme();
    mermaid.initialize({ 
      startOnLoad: true, 
      theme: config.theme,
      themeVariables: config.themeVariables,
      securityLevel: 'loose',
      fontFamily: 'inherit',
      fontSize: 18,
      htmlLabels: true,
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        useMaxWidth: true,
        diagramMarginX: 50,
        diagramMarginY: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35
      }
    });
  }
  
  // Store original Mermaid code before rendering
  function storeMermaidCode() {
    document.querySelectorAll('.mermaid').forEach(function(el) {
      if (!el.dataset.originalCode) {
        el.dataset.originalCode = el.textContent.trim();
      }
    });
  }
  
  // Re-render Mermaid diagrams with new theme
  function rerenderMermaid() {
    const config = getMermaidTheme();
    mermaid.initialize({ 
      startOnLoad: false,
      theme: config.theme,
      themeVariables: config.themeVariables,
      securityLevel: 'loose',
      fontFamily: 'inherit',
      fontSize: 18,
      htmlLabels: true,
      flowchart: {
        useMaxWidth: true,
        htmlLabels: true,
        curve: 'basis'
      },
      sequence: {
        useMaxWidth: true,
        diagramMarginX: 50,
        diagramMarginY: 10,
        boxTextMargin: 5,
        noteMargin: 10,
        messageMargin: 35
      }
    });
    
    // Re-render all mermaid diagrams
    document.querySelectorAll('.mermaid').forEach(function(el) {
      const originalCode = el.dataset.originalCode || el.textContent.trim();
      if (!originalCode) return;
      
      // Clear existing SVG
      el.innerHTML = originalCode;
      
      // Re-render
      const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
      mermaid.render(id, originalCode).then(function(result) {
        el.innerHTML = result.svg;
      }).catch(function(err) {
        console.error('Mermaid render error:', err);
      });
    });
  }
  
  // Store code before initial render
  document.addEventListener('DOMContentLoaded', function() {
    storeMermaidCode();
    initMermaid();
  });
  
  // If DOM is already loaded, store immediately
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', storeMermaidCode);
  } else {
    storeMermaidCode();
    initMermaid();
  }
  
  // Re-initialize on theme change
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'data-theme') {
        // Small delay to ensure theme change is complete
        setTimeout(function() {
          rerenderMermaid();
        }, 100);
      }
    });
  });
  
  observer.observe(document.documentElement, {
    attributes: true,
    attributeFilter: ['data-theme']
  });
</script>

