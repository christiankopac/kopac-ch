{{/*
  Advanced Image Shortcode using Hugo's native image processing
  
  Usage in Markdown:
  {{< img src="path/to/image.jpg" alt="Description" caption="Optional caption" width="800" height="600" dithered="false" >}}
  
  Parameters:
  - src: Path to the source image (required)
  - alt: Alt text for accessibility (required)
  - caption: Optional caption for figure
  - width: Target width in pixels (optional, default: 800)
  - height: Target height in pixels (optional, default: 600) 
  - op: Resize operation - "resize", "fit", "fill" (optional, default: "fit")
  - quality: JPEG/WebP quality 1-100 (optional, default: 85)
  - dithered: Whether to use dithered version (optional, default: false)
  - show_original: Show toggle for original (optional, default: true)
*/}}

{{ $src := .Get "src" }}
{{ $alt := .Get "alt" }}
{{ $caption := .Get "caption" }}
{{ $width := .Get "width" | default "800" }}
{{ $height := .Get "height" | default "600" }}
{{ $op := .Get "op" | default "fit" }}
{{ $quality := .Get "quality" | default "85" }}
{{ $dithered := eq (.Get "dithered") "true" }}
{{ $showOriginal := ne (.Get "show_original") "false" }}

{{/* Get the image resource */}}
{{ $img := "" }}
{{ $imgPath := strings.TrimPrefix "/" $src }}

{{/* Try to get the image from various locations */}}
{{ if .Page.Resources }}
  {{ $img = .Page.Resources.GetMatch $imgPath }}
{{ end }}
{{ if not $img }}
  {{ $img = resources.Get $imgPath }}
{{ end }}
{{ if not $img }}
  {{/* Try with leading slash */}}
  {{ $img = resources.Get $src }}
{{ end }}

{{ if $img }}
  {{/* Determine the source path for dithered version */}}
  {{ $baseSrc := $src }}
  {{ $ditheredSrc := replace $src (path.Ext $src) (printf "_dithered%s" (path.Ext $src)) }}
  
  {{ $ditheredImg := "" }}
  {{ if $dithered }}
    {{ $ditheredPath := strings.TrimPrefix "/" $ditheredSrc }}
    {{ if .Page.Resources }}
      {{ $ditheredImg = .Page.Resources.GetMatch $ditheredPath }}
    {{ end }}
    {{ if not $ditheredImg }}
      {{ $ditheredImg = resources.Get $ditheredPath }}
    {{ end }}
    {{ if not $ditheredImg }}
      {{ $ditheredImg = resources.Get $ditheredSrc }}
    {{ end }}
  {{ end }}
  
  {{/* Use Hugo's native image processing */}}
  {{ $processedImg := "" }}
  {{ $processedWebP := "" }}
  {{ $processedAVIF := "" }}
  {{ $processedDithered := "" }}
  {{ $processedOrigWebP := "" }}
  {{ $processedOrigAVIF := "" }}
  {{ $processedOrig := "" }}

  {{/* Build the process spec - use only width to preserve aspect ratio */}}
  {{ $spec := printf "%sx q%s" $width $quality }}
  {{ $webpSpec := printf "%sx webp q%s" $width $quality }}
  {{ $avifSpec := printf "%sx avif q%s" $width $quality }}

  {{/* Always use Resize with width only to preserve aspect ratio and prevent rotation */}}
  {{ $processedImg = $img.Resize $spec }}
  {{ $processedWebP = $img.Resize $webpSpec }}
  {{ $processedAVIF = $img.Resize $avifSpec }}
  {{ if $ditheredImg }}
    {{ $processedDithered = $ditheredImg.Resize $spec }}
  {{ end }}
  {{ if $showOriginal }}
    {{ $processedOrig = $img.Resize $spec }}
    {{ $processedOrigWebP = $img.Resize $webpSpec }}
    {{ $processedOrigAVIF = $img.Resize $avifSpec }}
  {{ end }}

  {{/* Wrap in figure if caption is provided */}}
  {{ if $caption }}
<figure class="responsive-image{{ if and $dithered $ditheredImg }} has-toggle{{ end }}" x-data="{ showOriginal: false }">
  <div class="image-container">
    {{ if and $dithered $ditheredImg }}
      {{/* Dithered images with toggle */}}
      <img class="dithered-img" 
           :class="{ active: !showOriginal }"
           x-show="!showOriginal"
           x-transition
           src="{{ $processedDithered.RelPermalink }}" 
           alt="{{ $alt }}" 
           width="{{ $processedDithered.Width }}" 
           height="{{ $processedDithered.Height }}"
           loading="lazy"
           decoding="async">
      {{ if $showOriginal }}
      <picture class="original-img" 
               x-show="showOriginal"
               x-transition
               style="display: none;">
        <source srcset="{{ $processedOrigAVIF.RelPermalink }}" type="image/avif">
        <source srcset="{{ $processedOrigWebP.RelPermalink }}" type="image/webp">
        <img src="{{ $processedOrig.RelPermalink }}"
             alt="{{ $alt }} (original)"
             width="{{ $processedOrig.Width }}"
             height="{{ $processedOrig.Height }}"
             loading="lazy"
             decoding="async">
      </picture>
      {{ end }}
    {{ else }}
      <picture>
        <source srcset="{{ $processedAVIF.RelPermalink }}" type="image/avif" width="{{ $processedAVIF.Width }}" height="{{ $processedAVIF.Height }}">
        <source srcset="{{ $processedWebP.RelPermalink }}" type="image/webp" width="{{ $processedWebP.Width }}" height="{{ $processedWebP.Height }}">
        <img src="{{ $processedImg.RelPermalink }}"
             alt="{{ $alt }}"
             width="{{ $processedImg.Width }}"
             height="{{ $processedImg.Height }}"
             loading="lazy"
             decoding="async">
      </picture>
    {{ end }}
  </div>
  <figcaption>
    {{ $caption | markdownify }}
    {{ if and $dithered $ditheredImg $showOriginal }}
    <button class="toggle-original" 
            @click="showOriginal = !showOriginal"
            type="button"
            :aria-pressed="showOriginal">
      <span x-show="!showOriginal">→ show original</span>
      <span x-show="showOriginal">← dither</span>
    </button>
    {{ end }}
  </figcaption>
</figure>
  {{ else }}
    {{/* No caption - just show image without toggle */}}
    {{ if and $dithered $ditheredImg }}
    <img class="responsive-image" 
         src="{{ $processedDithered.RelPermalink }}" 
         alt="{{ $alt }}" 
         width="{{ $processedDithered.Width }}" 
         height="{{ $processedDithered.Height }}"
         loading="lazy"
         decoding="async">
    {{ else }}
    <picture class="responsive-image">
      <source srcset="{{ $processedAVIF.RelPermalink }}" type="image/avif" width="{{ $processedAVIF.Width }}" height="{{ $processedAVIF.Height }}">
      <source srcset="{{ $processedWebP.RelPermalink }}" type="image/webp" width="{{ $processedWebP.Width }}" height="{{ $processedWebP.Height }}">
      <img src="{{ $processedImg.RelPermalink }}"
           alt="{{ $alt }}"
           width="{{ $processedImg.Width }}"
           height="{{ $processedImg.Height }}"
           loading="lazy"
           decoding="async">
    </picture>
    {{ end }}
  {{ end }}
{{ else }}
  <p><em>Image not found: {{ $src }}</em></p>
{{ end }}
